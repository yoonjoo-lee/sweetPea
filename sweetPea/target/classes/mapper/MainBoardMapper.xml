<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="pea.board.mapper.MainBoardMapper">

<!-- 메인보드 -->
<!-- 게시물 작성 -->
<insert id="write" parameterType="MainBoardVo">
	INSERT INTO pea_board(
		  title
		, content
		, uidx
		, ip
		, category
	) VALUES(
		  #{title}
		, #{content}
		, #{uidx}
		, #{ip}
		, #{category}
	)
</insert>

<!-- 게시물 글 목록 조회-->
<select id="selectAll" parameterType="SearchVo" resultType="MainBoardVo">
		SELECT  A.* 
		FROM (select @rownum:=@rownum+1 as rn, b.*,u.name
		 from pea_board b, pea_user u
		where b.uidx=u.uidx
		and category=#{category}
		and (@rownum:=0)=0
		<if test='searchType != null and searchType.equals("title")'>
	 		AND b.title like concat('%',#{searchValue},'%')
	 	</if>
	 	<if test='searchType != null and searchType.equals("contentWriter")'>
	 		AND b.content like concat('%',#{searchValue},'%')
	 		OR u.name like concat('%',#{searchValue},'%')
	 	</if>
	 	 and b.delyn='N'
	 	order by bidx desc
	 	) 
	 	<if test="list == 1">
	 		A  WHERE rn LIMIT 5;
	 	</if>
	 	<if test="list != 1">
	 		A  WHERE rn BETWEEN #{start} AND #{end};
	 	</if>
</select>

<!-- 페이징을 위한 총 글의 개수 구하기 -->
<select id="countBoard" parameterType="int" resultType="int">
	SELECT COUNT(*) 
	 FROM pea_board
	 WHERE category=#{category}
</select>

<!-- 게시물 각 글 조회-->
<select id="view" parameterType="int" resultType="MainBoardVo">
	SELECT b.*,u.name, u.uidx
	 FROM pea_board b, pea_user u
	WHERE b.uidx = u.uidx
	AND b.bidx = #{bidx}
</select>


<!-- 게시물 수정 -->
<update id="modify" parameterType="MainBoardVo">
	UPDATE pea_board
	 SET title=#{title}
	 	,content=#{content}
	 	,ip=#{ip}
	 	,datetime=now()
	 WHERE bidx=#{bidx}
</update>

<!-- 게시물 삭제 -->
<update id="delete" parameterType="int">
	UPDATE pea_board 
	 SET delyn='Y' 
	WHERE bidx=#{bidx}
</update>




<!-- 메인 보드 댓글 -->
<!-- 댓글 작성 -->
<insert id="writeReply" parameterType="MainCommentVo">
	INSERT INTO pea_comment(
		 bidx
		,content
		,writer
		,ip
		,origincidx
		,uidx
		,depth
	) VALUES(
		 #{bidx}
		,#{content}
		,#{writer}
		,#{ip}
		<if test="depth==1">
			,#{cidx}
		</if>
		<if test="depth!=1">
			,(SELECT max(cidx)+1 from pea_comment c)
		</if>
		,#{uidx}
		,#{depth}
	)
</insert>

<!-- 댓글 모두 조회 -->
<select id="selectComment" parameterType="MainCommentVo" resultType="MainCommentVo">
	SELECT * 
	 FROM pea_comment 
	WHERE bidx=#{bidx}
	AND delyn='N'
	ORDER BY origincidx,cidx
</select>

<!-- 댓글 수정 -->
<update id="modifyReply" parameterType="MainCommentVo">
	UPDATE pea_comment
	 SET content=#{content}
	 	,datetime=NOW()
	 	,ip=#{ip}
	WHERE cidx=#{cidx}
</update>

<!-- 댓글 삭제 -->
<update id="deleteReply" parameterType="int">
	UPDATE pea_comment
	 SET delyn='Y'
	WHERE cidx=#{cidx}
</update>



<!-- 신고 테이블 -->
<!-- 신고 게시물 작성 -->
<insert id="writeReport" parameterType="ReportVo">
<![CDATA[
	INSERT INTO pea_board(
		  title
		, content
		, uidx
		, ip
		, category
	) VALUES(
		  #{title}
		, #{content}
		, #{uidx}
		, #{ip}
		, #{category}
	) 
	]]>
	<selectKey resultType="int" keyProperty="bidx" order="AFTER">
	SELECT MAX(bidx) FROM pea_board
	</selectKey>
	
</insert>

<insert id="writeReport2" parameterType="ReportVo">
	INSERT INTO pea_report(
		  bidx
		, troll
		, report
		<if test="rbidx != null">
		, rbidx
		</if>
		<if test="rcidx != null">
		, rcidx
		</if>
	) VALUES(
		  #{bidx}
		, #{troll}
		, #{report}
		<if test="rbidx != null">
		, #{rbidx}
		</if>
		<if test="rcidx != null">
		, #{rcidx}
		</if>
	)
</insert>

</mapper>

















